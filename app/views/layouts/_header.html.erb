<nav class="navbar navbar-default navbar-fixed-top" id="navbarAgro" role="navigation">

  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header" id="header-bar">
    <a href="/"><img id="agrosocial_logo" src="/assets/logo_button.svg" alt="AgroSocial Logo" class="img-circle"></a>
    <a class="navbar-brand" id="brandAgro" href="/">AgroSocial</a>
  </div>

  <button type="button" id="navbarToggle" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
    <span class="sr-only">Toggle navigation</span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>

  </button>
  <!-- Collect the nav links, forms, and other content for toggling -->
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

    <ul class="nav navbar-nav navbar-right">
      
      <%= form_tag "/ads", :method => "get",:class=>"navbar-form navbar-left input-group", :id => "search" do %>
              <%= text_field_tag :search, params[:search],:class => "form-control typeahead" ,:style=>"vertical-align: center;",:autocomplete => "off",:id=>"search_query"  %>
             <input type="hidden" class="span1" name="IdControl" id="IdControl" value="" />

              <span class="input-group-btn">
                <input value="Pesquisar" type="hidden" class="btn btn-default" id="omnisearch-btn" >
              </span>
       <% end %>
      <!-- END SEARCH -->


      <!-- NOTIFICACOES -->
      <% if user_signed_in? %>
        <li class="dropdown messages-dropdown" >
          <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-globe" id="fa-globe"></i><span class="badge" id="custom-badge">3</span> <b class="caret" id="dropCarret"></b> </a>
          <ul class="dropdown-menu">

            <li class="dropdown-header">3 New </li>
            <li class="preview">
              <a href="#">
                <span class="avatar"><img src="http://placehold.it/50x50"></span>
                <span class="name">John Smith:</span>
                <span class="message">Hey there, I wanted to ask you something...</span>
                <span class="time"><i class="icon-time"></i> 4:34 PM</span>
              </a>
            </li>
            <li class="divider"></li>
            <li class="preview">
              <a href="#">
                <span class="avatar"><img src="http://placehold.it/50x50"></span>
                <span class="name">John Smith:</span>
                <span class="message">Hey there, I wanted to ask you something...</span>
                <span class="time"><i class="icon-time"></i> 4:34 PM</span>
              </a>
            </li>
            <li class="divider"></li>
            <li class="preview">
              <a href="#">
                <span class="avatar"><img src="http://placehold.it/50x50"></span>
                <span class="name">John Smith:</span>
                <span class="message">Hey there, I wanted to ask you something...</span>
                <span class="time"><i class="icon-time"></i> 4:34 PM</span>
              </a>
            </li>
            <li class="divider"></li>
            <li><a href="#">Ver Mais <span class="badge">3</span></a></li>

          </ul>
        </li>
        <!--END NOTIFICACOES-->

<%  #notifications from ads  %>
        <%= render "layouts/header_ads_notification" %>

<%  #notifications from academy  %>
        <%= render "layouts/header_academy_notification" %>

        <!-- USER-->
<%  #user menu  %>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" style="padding-top:9px; padding-bottom:9px;" data-toggle="dropdown" >
            <!--<% image_tag current_user.avatar.url%>-->
            <span><%= image_tag current_user.avatar.url(:medium), style:"height:35px; " %></span>
            <!--<span><%= image_tag current_user.avatar.url(:tiny) %></span>-->
            <b class="caret" id="dropCarret"></b>
          </a>

          <ul class="dropdown-menu">

            <!-- Messages -->
            <% if !@last_message.nil? %>
              <% @last_message.each do |m| %>
                <li class="preview">
                  <a href="#">
                    <span class="name">Enviado: <%= m.sender.name %></span><br />
                    <span class="message"><%= truncate(m.text,:length => 20) %></span><br />
                    <span class="time" align="rigth"><i class="icon-time"></i><small><%= m.created_at %></small></span>
                  </a>
                </li>
                <li class="divider"></li>
              <%end%>
              <li><a href="#">Ver Mais <span class="badge"><%= (@last_message.count - 3) %></span></a></li>
            <% else %>
              <li class="preview"><span class="name"><i class="fa fa-envelope-o"></i>Sem Mensagens</span><br /></li>
              <li class="divider"></li>
              <li>
                  <%= link_to "Caixa de Mensagens", messages_path %>
              </li>
            <% end %>
            <li class="divider"></li>

            <li><a href="/users/<%= current_user.id %>">Perfil</a></li>
            <li><%= link_to(ratings_path) do %>
                      <span>Rating por atribuir <span class="badge"><%= load_stuff_header %></span></span>
                    <% end %></li>
            <li class="divider"></li>
            <li><%= link_to "Terminar SessÃ£o",destroy_user_session_path, method: :delete %></li>

          </ul>
        </li>


      <% else %>
        <li><%= link_to "Login".html_safe , new_user_session_path %></li>
        <li><%= link_to "Registo", new_user_registration_path %></li>
      <% end %>
      <!--END USER-->

    </ul>

  </div><!-- /.navbar-collapse -->
</nav>

<!-- SCRIPT PARA O AUTOCOMPLETE -->
<script type="text/javascript">
           $(function(){
                //window.query_cache = {};
                var labels = [];
                var mapped = {};
                $('.typeahead').typeahead({
                  source: function (query, process) {
                    labels = [];
                    mapped = {};
                     return $.ajax({
                      url: "/search",
                      type: 'get',
                      data: { query: query },
                      dataType: 'json',
                      success: function (result) {


                        $.each(result, function (i, item) {
                           mapped[item.title] = {
                                id: item.id,
                                title: item.title,
                                category: item.category,
                                tipo: item.tipo,
                                img: item.img,
                                link: item.link
                           }
                           labels.push(item.title)

                          //alert(item.id + item.title)

                        });
                        return process(labels);

                      }
                  });
                },
                 highlighter: function(item){
                    var p = mapped[item];
                    var itm = ''
                             + "<div class='typeahead_wrapper'>"
                             + "<img class='typeahead_photo' src='"+ p.img +"' />"
                             + "<div class='typeahead_labels'>"
                             + "<div class='typeahead_primary'>" + p.title + "</div>"
                             + "<div class='typeahead_secondary'>" + p.category + " | "+ p.tipo +"</div>"
                             + "</div>"
                             + "</div>";
                    return itm;
                },
                 updater: function ( item ) {
                    //save the id value into the hidden field
                    $( "#IdControl" ).val( mapped[item].id );
                    //alert(mapped[item].id)
                    window.location.href = mapped[item].link;
                    //return the string you want to go into the textbox (the name)
                    //alert(item)
                    //return item;
                }
              });

          });


      </script>
